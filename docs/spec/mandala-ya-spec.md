# Maṇḍalāya（曼荼羅盤）— 要件定義書

> **文書バージョン:** 1.0  
> **作成日:** 2026-02-27  
> **ステータス:** プロトタイプ完了 → 本格実装フェーズへ移行  

---

## 1. プロジェクト概要

### 1.1 アプリ名

| 用途 | 表記 |
|------|------|
| 表示名（正式名称） | Maṇḍalāya |
| プロジェクト名 / ファイル名 / リポジトリ名 | mandala-ya |
| 日本語愛称 / サブタイトル | 曼荼羅盤 |

ウィンドウタイトル・About画面での表示例:
```
Maṇḍalāya — 曼荼羅盤
```

語源: maṇḍala（曼荼羅）+ ālaya（サンスクリットで「住処・蔵・場所」）= 曼荼羅の在り処

### 1.2 背景

マンダラート（Mandal-Art）は今泉浩晃氏が1987年に考案した発想法で、3×3のグリッドを再帰的に展開して思考を深める手法。公式アプリ（Hiro Art Directions社）は2026年現在入手不可のため、同等の機能を持つアプリケーションを新規開発する。

### 1.3 目的

- オリジナルMandal-Artアプリの操作感を再現する思考支援ツールの開発
- キーボード操作による高速な思考入力を重視
- 再帰的な階層構造による無限の深掘りを実現
- 複数形式でのエクスポートによるデータ活用

### 1.4 技術スタック

| レイヤー | 技術 |
|----------|------|
| フレームワーク | Tauri v2 |
| フロントエンド | React + TypeScript |
| 状態管理 | Zustand（推奨） |
| データ永続化 | Tauri fs API / tauri-plugin-store |
| ビルド | Vite |

### 1.5 対象プラットフォーム

デスクトップアプリ（Tauri）のみ。Web版は対象外。

- macOS
- Windows
- Linux

### 1.6 参考資料

- プロトタイプ（React Artifact）: リポジトリ `mandala-ya` 内 `docs/prototype/mandala-chart-v2.jsx`
- Mandal-Art公式サイト: https://www.mandal-art.com/

---

## 2. 用語定義

| 用語 | 定義 |
|------|------|
| **ユニット（Unit）** | 3×3＝9マスで構成されるグリッドの1セット |
| **主題セル（Center Cell）** | ユニットの中央（position: 4）。そのユニットのテーマを示す |
| **関連セル（Related Cell）** | 主題セルを囲む8マス（position: 0-3, 5-8）。主題に関連するキーワードを記入 |
| **ユニットビュー** | 1つのユニット（3×3）を編集する画面 |
| **俯瞰ビュー** | 現在のユニット＋関連セルの子ユニットを3×3に並べた全体表示（最大81マス相当） |
| **ドリルダウン** | 関連セルを中心にした子ユニットへ階層を降りる操作 |
| **ドリルアップ** | 親ユニットへ階層を上がる操作 |
| **チャート（Chart）** | 1つのマンダラチャート全体。ルートユニットをトップとするツリー構造 |

---

## 3. データモデル

### 3.1 型定義（TypeScript）

```typescript
interface MandalaCell {
  id: string;          // 一意識別子
  text: string;        // セルのテキスト内容（最大1,024文字）
  position: number;    // ユニット内の位置 0-8
  children: MandalaUnit | null;  // 再帰: 子ユニット（関連セルのみ）
  image: string | null;          // 画像ファイル名（例: "cell-abc123.png"）
}

interface MandalaUnit {
  id: string;          // 一意識別子
  cells: MandalaCell[];  // 必ず9要素（position 0-8）
}

interface MandalaChart {
  id: string;
  title: string;
  rootUnit: MandalaUnit;
  createdAt: string;   // ISO 8601
  updatedAt: string;   // ISO 8601
}
```

### 3.2 ポジションマッピング

```
ユニット内のセル配置:

  position:
  ┌─────┬─────┬─────┐
  │  0  │  1  │  2  │
  ├─────┼─────┼─────┤
  │  3  │  4  │  5  │  ← 4 = 主題セル
  ├─────┼─────┼─────┤
  │  6  │  7  │  8  │
  └─────┴─────┴─────┘
```

### 3.3 再帰構造の例

```
rootUnit
├── cells[0] "体力"     → children: Unit { cells[4]="体力", cells[0]="ランニング", ... }
├── cells[1] "メンタル" → children: Unit { cells[4]="メンタル", ... }
├── cells[2] "人間性"   → children: null（未展開）
├── cells[3] "運"       → children: null
├── cells[4] "ドラ1 8球団"  ← 主題セル（childrenなし）
├── cells[5] "変化球"   → children: null
├── cells[6] "スピード" → children: null
├── cells[7] "コントロール" → children: null
└── cells[8] "キレ"     → children: null
```

### 3.4 データ同期ルール

- **親→子の自動同期**: 親ユニットの関連セルのテキストを変更すると、対応する子ユニットの主題セル（position: 4）のテキストも自動更新される
- **子ユニットの主題セルは読み取り専用**: 2階層目以降の主題セルは親から継承されるため、直接編集不可
- **子ユニットの作成タイミング**: ドリルダウン操作時に、子ユニットが存在しなければ自動生成

### 3.5 永続化フォーマット

内部データはJSON形式で保持する。画像は専用フォルダに保存し、JSONには画像ファイル名のみ記録する。

#### フォルダ構成

```
{保存先ディレクトリ}/
├── 目標設定2026.json
└── 目標設定2026_images/
    ├── cell-abc123.png
    ├── cell-def456.jpg
    └── ...
```

- `_images/` フォルダはJSONファイル名（拡張子除く）+ `_images` で命名
- 画像はファイルダイアログで選択した元画像を `_images/` フォルダにコピーして保持（ポータビリティ確保）
- 対応形式: JPG, PNG
- 画像のフルパスは `{JSONファイルの保存先}/{JSONファイル名}_images/{image}` で解決

#### 画像ガベージコレクション

チャート保存時に `_images/` フォルダ内のファイルを走査し、どのセルの `image` フィールドからも参照されていないファイルを自動削除する。

#### JSON例

```json
{
  "id": "chart-001",
  "title": "目標設定 2026",
  "rootUnit": {
    "id": "unit-root",
    "cells": [
      {
        "id": "cell-1",
        "text": "体力",
        "position": 0,
        "children": {
          "id": "unit-001",
          "cells": [
            { "id": "cell-10", "text": "ランニング", "position": 0, "children": null, "image": "cell-10.png" },
            { "id": "cell-11", "text": "...", "position": 1, "children": null, "image": null },
            "..."
          ]
        }
      },
      "..."
    ]
  },
  "createdAt": "2026-02-27T10:00:00+09:00",
  "updatedAt": "2026-02-27T15:30:00+09:00"
}
```

---

## 4. 画面仕様

### 4.1 画面構成

```
┌──────────────────────────────────────────────────────────┐
│ [曼] Maṇḍalāya｜{主題セル内容}  階層:N  [俯瞰|ユニット] [💾保存] [📤エクスポート] │  ← ヘッダー
├──────────────────────────────────────────────────────────┤
│ 主題 › キーワードA › キーワードB                          │  ← パンくずリスト
├──────────────────────────────────────────────────────────┤
│                                                          │
│                  （メインコンテンツ）                       │  ← ユニットビュー or 俯瞰ビュー
│                                                          │
├──────────────────────────────────────────────────────────┤
│ Enter→確定  Esc→取消  Alt+数字→移動  ...                  │  ← フッター（操作ヘルプ）
└──────────────────────────────────────────────────────────┘
```

### 4.2 ユニットビュー

- 1つのユニット（3×3グリッド）を大きく表示し編集する画面
- ウィンドウの短辺（幅・高さの小さい方）に合わせてユニットサイズが拡縮する
- フォントサイズ、ボタンサイズ、gap、border-radius もユニットサイズに比例してスケール
- 基準サイズ: 400px、最小サイズ: 280px
- スケール計算: `scale = unitSize / 400`

#### セルの表示仕様

| 要素 | 主題セル | 関連セル |
|------|---------|---------|
| 背景色 | パレットのaccent色（濃色） | パレットのbg色（淡色） |
| 文字色 | 白 | #1a1a1a |
| フォントウェイト | 700 (bold) | 400 (regular) |
| フォントサイズ | 14px × scale | 14px × scale |
| ↑ボタン | 左上隅（2階層目以降のみ） | — |
| ↗ボタン | 右上隅（テキスト入力済みのみ） | 右上隅（テキスト入力済みのみ） |
| ↓ボタン | — | 右下隅（テキスト入力済みのみ） |
| 🖼ボタン | — | 左下隅（画像追加/差し替え） |

#### セルのレイヤー構造

セルは2レイヤーで構成する（CSS `position: relative` / `absolute`）:

```
┌──────────────────────┐
│  テキストボックス       │  ← 上レイヤー（背景透過、z-index: 1）
│  （背景透過）          │
├──────────────────────┤
│                      │
│    背景画像           │  ← 下レイヤー（object-fit: cover、z-index: 0）
│                      │
└──────────────────────┘
```

- 画像未設定時: 下レイヤーは非表示、通常のセル背景色が適用される
- 画像設定時: 下レイヤーに画像表示、テキストは背景透過で画像の上に重なる

#### 🖼ボタン（画像追加/削除）

- 位置: 関連セル左下隅
- サイズ: 22px × scale
- **状態によりアイコンと動作が切り替わる:**

| セルの画像状態 | アイコン | クリック動作 |
|--------------|---------|------------|
| 未設定 | 🖼（画像追加） | ファイルダイアログを開く（JPG, PNG のみ選択可） |
| 設定済み | ✕（画像削除） | 画像を削除（`image` フィールドを `null` に。ファイルはGCで処理） |

- 画像追加後: 選択画像を `_images/` フォルダにコピーし、セルの `image` フィールドを更新
- 画像差し替え: 削除（✕）→ 追加（🖼）の2ステップで行う
- いずれの操作もUndo履歴にスナップショットを記録し、自動保存が発動

#### ↗ボタン（モーダルエディタ起動）

- 位置: セル右上隅（主題セル・関連セル共通）
- サイズ: 22px × scale
- 表示条件: テキストが入力済みのセルのみ
- クリック動作: モーダルエディタを開く（セルのテキスト全文を編集可能）

#### モーダルエディタ

セルのテキストを広いテキストエリアで編集するためのモーダルダイアログ。

```
┌─────────────────────────────────────┐
│ ✕  セルテキスト編集                    │  ← タイトルバー + 閉じるボタン
├─────────────────────────────────────┤
│                                     │
│  （リサイズ可能なテキストエリア）        │
│                                     │
│                                     │
│                                     │
├─────────────────────────────────────┤
│                        128 / 1,024  │  ← 文字数カウンター
│             [キャンセル]  [保存]      │
└─────────────────────────────────────┘
```

| 要素 | 仕様 |
|------|------|
| テキストエリア | プレーンテキスト（リッチテキスト不要）。リサイズ可能 |
| 文字数カウンター | 右下に `{現在の文字数} / {最大文字数}` を小さく表示 |
| 文字数カウント方式 | `Intl.Segmenter` による書記素クラスタ単位。1バイト文字も4バイト文字も絵文字も1文字 |
| 最大文字数 | 1,024文字。上限到達時はカウンター表示を赤色に変更し入力を制限 |
| 保存ボタン / `Ctrl + Enter` | テキストをセルに書き戻し、Undo履歴記録＋自動保存。モーダルを閉じる |
| キャンセルボタン / `Esc` | 変更を破棄しモーダルを閉じる |
| `Enter` | 改行入力（保存ではない） |
| 背景 | モーダル背景は半透明オーバーレイ |

#### セル上のテキスト表示

セル上では文字数に関わらずセル枠内に収まる範囲のみ表示する（overflow: hidden）。全文はモーダルエディタで確認・編集する。

#### ↓ボタン（ドリルダウン）

- 位置: 関連セル右下隅
- サイズ: 22px × scale
- 表示条件: テキストが入力済みの関連セルのみ
- 外観: 子ユニットが既に存在する場合は塗りつぶし、未作成の場合は枠線のみ
- クリック動作: 子ユニットへ遷移（未作成の場合は自動生成）

#### ↑ボタン（ドリルアップ）

- 位置: 主題セル左上隅
- サイズ: 22px × scale
- 表示条件: 2階層目以降のユニットのみ（最上位では非表示）
- クリック動作: 親ユニットへ遷移

#### 主題セルの左右padding

- 2階層目以降（↑ボタン表示時）: `btnSize / 2` px
- 最上位階層: 0

### 4.3 俯瞰ビュー

現在のユニットを中央に、各関連セルの子ユニットを周囲に配置した3×3のグリッド表示。

```
┌─────────────┬─────────────┬─────────────┐
│  cells[0]   │  cells[1]   │  cells[2]   │
│  の子Unit   │  の子Unit   │  の子Unit   │
├─────────────┼─────────────┼─────────────┤
│  cells[3]   │ ★ 現在の    │  cells[5]   │
│  の子Unit   │  ユニット    │  の子Unit   │
├─────────────┼─────────────┼─────────────┤
│  cells[6]   │  cells[7]   │  cells[8]   │
│  の子Unit   │  の子Unit   │  の子Unit   │
└─────────────┴─────────────┴─────────────┘
```

#### 表示パターン

| 状態 | 表示内容 |
|------|---------|
| 子ユニットあり & 関連セルに入力あり | 3×3のミニグリッドを表示 |
| 子ユニットあり & 主題のみ入力 | 3×3グリッドを表示（主題のみ表示） |
| 子ユニットなし & テキストあり | テキストをプレースホルダーとして表示（パレットbg色） |
| 子ユニットなし & テキストなし | 空欄 |

#### クリック動作

| 状態 | クリック時の動作 |
|------|----------------|
| 中央グリッド（現在のユニット） | ユニットビューに切り替え |
| 子ユニットあり | 当該子ユニットのユニットビューへ遷移 |
| 子ユニットなし & テキストあり | 子ユニットを自動生成しユニットビューへ遷移 |
| 子ユニットなし & テキストなし | 無動作 |

### 4.4 パンくずリスト

- ルートユニットから現在のユニットまでの経路を表示
- 各階層のラベルは主題セルのテキスト（未入力の場合は「主題」or「未入力」）
- クリックで任意の階層にジャンプ可能
- 現在の階層は太字、上位階層はリンク表示（青色・下線）

### 4.5 ヘッダー

- アプリアイコン（「曼」ロゴ）+ タイトル「Maṇḍalāya」
- 区切り「｜」の後に**ルートユニットの主題セル内容**を表示（未入力時は非表示 or プレースホルダー）
- 現在の階層番号の表示（バッジ）
- ビュー切り替えトグル:「俯瞰」/「ユニット」
- 💾 保存ボタン: ファイルダイアログを開き、作業ファイルの保存先を設定/変更
- 📤 エクスポートボタン: ファイルダイアログを開き、現在のデータを別のJSONファイルに書き出す

### 4.6 フッター（操作ヘルプ）

画面下部に固定表示。以下のショートカット一覧を表示:

```
Enter→確定  Esc→取消  Alt+数字→セル移動  Alt+Shift+数字→入替  Alt+E→エディタ  Alt+Ctrl+数字→下階層  Alt+U→上階層  Alt+V→ビュー切替  Alt+G→AI  Ctrl+Z/Shift+Z→戻す/やり直す
```

---

## 5. キーボード操作仕様

### 5.1 キーアサイン一覧

#### セル操作

| 操作 | ショートカット | 有効画面 | 備考 |
|------|---------------|---------|------|
| セル編集開始 | `Alt + 数字` or `Alt + テンキー` | ユニットビュー | |
| 編集確定 | `Enter` | セル編集中 | 単独Enter |
| 編集キャンセル | `Esc` | セル編集中 | 変更を破棄 |
| モーダルエディタ起動 | `Alt + E` | ユニットビュー | フォーカス中のセル。テキスト入力済みのみ |
| セル入れ替え | `Alt + Shift + 数字` | ユニットビュー | フォーカス中のセルと指定セルを入れ替え。関連セル同士のみ |

#### 階層ナビゲーション

| 操作 | ショートカット | 有効画面 | 備考 |
|------|---------------|---------|------|
| 下階層へ移動 | `Alt + Ctrl + 数字` or `Alt + Ctrl + テンキー` | ユニットビュー | 主題セル(5)は無効、テキスト未入力も無効 |
| 上階層へ移動 | `Alt + U` or `Alt + ←` | ユニットビュー | 最上位階層では無動作 |
| 直前の子階層へ戻る | `Alt + →` | ユニットビュー | ドリルアップ直後のみ有効（履歴ナビゲーション） |

#### ビュー・ファイル操作

| 操作 | ショートカット | 有効画面 | 備考 |
|------|---------------|---------|------|
| ビュー切り替え | `Alt + V` | 全画面 | 俯瞰⇔ユニットのトグル |
| 保存（Save As） | `Ctrl + Shift + S` (Win/Linux) / `Cmd + Shift + S` (Mac) | 全画面 | ファイルダイアログで保存先設定/変更 |
| エクスポート | `Ctrl + E` (Win/Linux) / `Cmd + E` (Mac) | 全画面 | ファイルダイアログで別ファイルに書き出し |

#### 画像操作

| 操作 | ショートカット | 有効画面 | 備考 |
|------|---------------|---------|------|
| 画像追加 | `Alt + I` | ユニットビュー | フォーカス中の関連セルにファイルダイアログで画像追加 |
| 画像削除 | `Alt + Shift + I` | ユニットビュー | フォーカス中の関連セルの画像を削除 |

#### Undo/Redo・AI

| 操作 | ショートカット | 有効画面 | 備考 |
|------|---------------|---------|------|
| 元に戻す | `Ctrl + Z` (Win/Linux) / `Cmd + Z` (Mac) | 全画面 | セル編集中・モーダル内はOS標準Undo |
| やり直す | `Ctrl + Shift + Z` (Win/Linux) / `Cmd + Shift + Z` (Mac) | 全画面 | セル編集中・モーダル内はOS標準Redo |
| AIアシスト | `Alt + G` | ユニットビュー | 主題セルのみ入力済みの場合に有効 |

#### モーダルエディタ内

| 操作 | ショートカット | 備考 |
|------|---------------|------|
| 保存して閉じる | `Ctrl + Enter` (Win/Linux) / `Cmd + Enter` (Mac) | Enter単独は改行 |
| キャンセルして閉じる | `Esc` | 変更を破棄 |

### 5.2 数字キーとグリッド位置の対応

```
数字キー / テンキー配列:

  ┌─────────┬─────────┬─────────┐
  │  7 → [0]│  8 → [1]│  9 → [2]│
  ├─────────┼─────────┼─────────┤
  │  4 → [3]│  5 → [4]│  6 → [5]│
  ├─────────┼─────────┼─────────┤
  │  1 → [6]│  2 → [7]│  3 → [8]│
  └─────────┴─────────┴─────────┘
```

### 5.3 キーコードマッピング

```typescript
const KEY_TO_POSITION: Record<string, number> = {
  // テンキー
  "Numpad7": 0, "Numpad8": 1, "Numpad9": 2,
  "Numpad4": 3, "Numpad5": 4, "Numpad6": 5,
  "Numpad1": 6, "Numpad2": 7, "Numpad3": 8,
  // 数字キー（ノートPC対応）
  "Digit7": 0, "Digit8": 1, "Digit9": 2,
  "Digit4": 3, "Digit5": 4, "Digit6": 5,
  "Digit1": 6, "Digit2": 7, "Digit3": 8,
};
```

### 5.4 編集中のショートカット動作

セル編集中（textarea表示中）にAlt+数字が押された場合:
1. 現在の編集内容を確定（commit）
2. グローバルハンドラにイベントを伝播
3. 指定セルの編集を開始

### 5.5 Undo/Redo 仕様

#### 基本方針

スナップショット方式を採用。チャート全体の状態をスナップショットとして保持し、Undo/Redo時に状態を丸ごと復元する。

#### 実装

- **ライブラリ**: Zustand `temporal` ミドルウェア（`zundo`）
- **履歴上限**: 64ステップ
- **スナップショット対象**: `MandalaChart` 全体（`rootUnit` の再帰ツリーを含む）
- **スナップショット記録タイミング**: セル編集の commit 時（Undo/Redo の単位 = 1回のセル編集）

#### 動作ルール

| 状態 | Ctrl+Z / Cmd+Z | Ctrl+Shift+Z / Cmd+Shift+Z |
|------|---------------|----------------------------|
| 履歴あり | 1ステップ戻る | 1ステップ進む |
| 履歴なし（先頭/末尾） | 無動作 | 無動作 |
| セル編集中（textarea表示中） | OS標準のテキストUndoが動作 | OS標準のテキストRedoが動作 |

- Undo後に新たな編集を行うと、Undo前の履歴（Redo履歴）は破棄される（標準的な挙動）
- Undo/Redo後も自動保存が発動する（復元した状態がファイルに保存される）

### 5.6 ドラッグ&ドロップ / セル入れ替え仕様

#### 対象範囲

同一ユニット内の関連セル同士の入れ替えのみ。ユニット間の移動は対象外。

#### マウス操作（D&D）

| ドラッグ元 | ドロップ先 | 動作 |
|-----------|----------|------|
| 関連セル | 関連セル | テキストと子ユニット（children）をまるごと入れ替え |
| 関連セル | 主題セル | 無効（ドロップ不可） |
| 主題セル | — | ドラッグ不可 |

#### キーボード操作

`Alt + Shift + 数字` で、現在フォーカス中のセルと指定番号のセルを直接入れ替える。

- フォーカス中のセルが関連セルであること
- 指定先も関連セルであること（主題セル=5は無効）
- フォーカス中のセルと同じ番号を指定した場合は無動作

#### 共通ルール

- 入れ替えはテキストだけでなく `children`（子ユニットツリー全体）も含む
- 入れ替え完了時に Undo 履歴にスナップショットを記録
- 入れ替え完了時に自動保存が発動

### 5.7 階層ナビゲーション履歴

`Alt + ←` / `Alt + →` による階層間の戻る/進む機能。

#### 動作ルール

| キー | 動作 | 備考 |
|------|------|------|
| `Alt + ←` | 親ユニットへ移動 | `Alt + U` と同じ動作。最上位では無動作 |
| `Alt + →` | 直前にドリルアップで離れた子ユニットへ戻る | ドリルアップ直後のみ有効 |

- `Alt + →` は直前の `Alt + ←` / `Alt + U` による移動を1ステップ戻す
- 新たにドリルダウン（`Alt + Ctrl + 数字`）を行うと「進む」履歴はクリアされる（Undo/Redoと同じ原理）
- 履歴スタックの深さは階層数に依存（実用上3〜5段階）

### 5.8 AIアシスト仕様

#### 概要

現在のユニットの主題キーワードに対して、AIが関連キーワードを最大8つ生成し、各関連セルに自動配置する機能。

#### 実行条件

- **主題セル（position: 4）にテキストが入力済み**であること
- **すべての関連セル（position: 0-3, 5-8）が空欄**であること
- 上記を満たさない場合は無動作（トースト通知で理由を表示）

#### 動作フロー

```
Alt + G 押下
 ├→ 実行条件チェック
 │   ├→ 条件不満足 → トースト:「主題セルのみ入力済みの状態で実行してください」
 │   └→ 条件満足 → 続行
 ├→ APIキー設定チェック
 │   └→ 未設定 → トースト:「設定画面でAPIキーを設定してください」
 ├→ ローディング表示（ユニット全体をオーバーレイ + スピナー）
 ├→ API呼び出し
 │   プロンプト:「"{主題キーワード}"に関連するキーワードを8つ挙げてください。
 │              JSON配列で返してください。例: ["キーワード1", "キーワード2", ...]」
 ├→ レスポンス受信
 │   └→ 8つのキーワードを position 0,1,2,3,5,6,7,8 に順次配置
 ├→ Undo 履歴にスナップショットを記録
 └→ 自動保存
```

#### API設定

設定画面で以下を管理する:

| 設定項目 | 値 |
|---------|-----|
| プロバイダー | Claude API / Amazon Bedrock（選択式） |
| APIキー | ユーザー入力。`tauri-plugin-store` で暗号化保存 |
| モデル | claude-haiku-4-5（デフォルト）等。プロバイダーに応じた選択肢 |

#### エラーハンドリング

| エラー | 対応 |
|-------|------|
| API不通 / タイムアウト | トースト:「AIアシストを利用できません。ネットワーク接続を確認してください」 |
| APIキー無効 | トースト:「APIキーが無効です。設定画面で確認してください」 |
| レスポンスのパース失敗 | トースト:「AIからの応答を処理できませんでした。再度お試しください」 |

---

## 6. 保存・エクスポート仕様

### 6.1 保存とエクスポートの区別

| 操作 | ボタン | 動作 | 自動保存先への影響 |
|------|-------|------|-------------------|
| **保存** | 💾 保存 | ファイルダイアログで作業ファイルの保存先を設定/変更 | 変更される（以降の自動保存先になる） |
| **エクスポート** | 📤 エクスポート | ファイルダイアログで別のJSONファイルに書き出す | 変更されない |

### 6.2 自動保存

セルの編集が確定（commit）されるたびに、作業ファイルに自動保存する。

- **トリガー**: セル編集の commit 時（Enter確定、フォーカス移動、Alt+数字による移動時）
- **debounce**: 500ms（連続編集時のディスクI/O最適化）
- **前提条件**: 保存先が設定済みであること
- **保存先未設定時**: 自動保存は行わない。初回「保存」ボタン押下時にファイルダイアログで設定

#### 起動時のフロー

```
アプリ起動
 ├→ 前回の保存先が記録されている
 │   └→ ファイル存在する → 読み込んで編集再開
 │   └→ ファイル存在しない → 新規チャートで開始（保存先はリセット）
 └→ 前回の保存先が未記録
     └→ 新規チャートで開始
```

前回の保存先パスは `tauri-plugin-store` でアプリ設定として永続化する。

### 6.3 クラウドストレージ連携

ローカル同期フォルダ方式を採用。ファイルダイアログで各クラウドサービスの同期フォルダを保存先に選択することで、サービス側のクライアントアプリが自動的にデバイス間同期を行う。

対応サービス（ユーザー側でデスクトップクライアントのインストールが必要）:

- iCloud Drive
- Google Drive（Google ドライブ デスクトップアプリ）
- Dropbox

アプリ側での特別な実装は不要。ファイルダイアログから同期フォルダを選べる仕組みそのもの。

### 6.4 対応エクスポート形式

| 形式 | 拡張子 | ファイル分割 |
|------|-------|-------------|
| JSON | .json | 単一ファイル（再帰構造をネストで全階層包含） |
| Markdown | .md | 単一ファイル（見出しレベルで階層表現） |
| OPML | .opml | 単一ファイル（アウトラインのツリー構造で全階層表現） |

### 6.5 JSON エクスポート

チャート全体を単一JSONファイルとして出力。再帰構造がそのままネストされるため、全階層のデータが1ファイルに含まれる。インポート時はこのファイルをそのまま読み込む。

### 6.6 Markdown エクスポート（未実装）

再帰構造全体を単一Markdownファイルに変換。見出しレベル（#, ##, ###...）で階層を表現し、最下層のセルをリスト項目として出力する。

```markdown
# ドラ1 8球団

## 体力
- ランニング
- 柔軟性
- RSC 130km
- スタミナ
- 可動域
- 食事 夜7杯 朝3杯
- サプリメント
- FSQ 90kg

## メンタル
- メンタル強化
- 仲間を思いやる
- ...
```

階層が深い場合は見出しレベルを ###, #### と増やし、ツリー全体を1ファイルで表現する。画像が設定されたセルには `![セルテキスト](相対パス)` 形式で画像参照を出力する。

### 6.7 OPML エクスポート（未実装）

再帰構造全体を単一OPMLファイルに変換。アウトラインプロセッサ（OmniOutliner、Dynalist、WorkFlowy等）との連携に使用する。変換ロジックはMarkdownエクスポートとほぼ同一（出力形式のみ異なる）。

```xml
<opml version="2.0">
  <head>
    <title>ドラ1 8球団</title>
  </head>
  <body>
    <outline text="ドラ1 8球団">
      <outline text="体力">
        <outline text="ランニング"/>
        <outline text="柔軟性"/>
        <outline text="RSC 130km"/>
        <outline text="スタミナ"/>
        <outline text="可動域"/>
        <outline text="食事 夜7杯 朝3杯"/>
        <outline text="サプリメント"/>
        <outline text="FSQ 90kg"/>
      </outline>
      <outline text="メンタル">
        <outline text="メンタル強化"/>
        <outline text="仲間を思いやる"/>
      </outline>
    </outline>
  </body>
</opml>
```

各 `<outline>` 要素は `MandalaCell` に対応し、子ユニットがある場合は再帰的にネストする。主題セル（position: 4）が親 `<outline>` の `text` となり、関連セル（position: 0-3, 5-8）が子 `<outline>` となる。画像情報はOPML形式では出力しない（テキストのみ）。

---

## 7. カラーパレット

### 7.1 グリッド別カラー定義

各ユニットは position（または階層深度）に応じて異なるカラーパレットを使用。

| Index | 用途例 | bg（淡色） | border | center（濃色） |
|-------|-------|-----------|--------|---------------|
| 0 | オレンジ系 | #FFF3E0 | #EF6C00 | #EF6C00 |
| 1 | グリーン系 | #E8F5E9 | #2E7D32 | #2E7D32 |
| 2 | ブルー系 | #E3F2FD | #1565C0 | #1565C0 |
| 3 | ピンク系 | #FCE4EC | #C2185B | #C2185B |
| 4 | パープル系 | #EDE7F6 | #512DA8 | #512DA8 |
| 5 | ティール系 | #E0F2F1 | #00796B | #00796B |
| 6 | イエロー系 | #FFF8E1 | #F9A825 | #F9A825 |
| 7 | ディープパープル系 | #F3E5F5 | #7B1FA2 | #7B1FA2 |
| 8 | ブラウン系 | #EFEBE9 | #5D4037 | #5D4037 |

### 7.2 UIカラー

| 要素 | 色 |
|------|-----|
| 背景 | #fafafa |
| テキスト | #1a1a1a |
| ヘッダー背景 | #ffffff |
| ヘッダーボーダー | #e8e8e8 |
| ロゴグラデーション | linear-gradient(135deg, #512DA8, #1565C0) |
| パンくずリンク | #1565C0 |
| フッターテキスト | #aaaaaa |

---

## 8. 実装フェーズ

### Phase 1: プロジェクト初期設定

- [ ] GitHub リポジトリ作成
- [ ] Tauri v2 + React + TypeScript + Vite プロジェクト初期化
- [ ] プロトタイプ（mandala-chart-v2.jsx）を `docs/prototype/` に格納
- [ ] 状態管理ライブラリ導入（Zustand推奨）
- [ ] ディレクトリ構成の策定

### Phase 2: コアUIの移植

- [ ] MandalaCell / MandalaUnit / MandalaChart 型定義
- [ ] EditableCell コンポーネント
- [ ] UnitGrid コンポーネント
- [ ] FocusView（ユニットビュー）
- [ ] OverviewView（俯瞰ビュー）
- [ ] Breadcrumbs コンポーネント
- [ ] レスポンシブサイズ計算ロジック（短辺追従）
- [ ] カラーパレットシステム
- [ ] Undo/Redo（Zustand temporal、スナップショット方式、64ステップ）
- [ ] ドラッグ&ドロップ（同一ユニット内の関連セル入れ替え）
- [ ] セルのレイヤー構造（テキスト上レイヤー＋画像下レイヤー）
- [ ] 🖼画像追加ボタン（ファイルダイアログ、JPG/PNG対応）
- [ ] ↗モーダルエディタ（プレーンテキスト、1,024文字上限、Intl.Segmenter文字数カウント）

### Phase 3: データ管理

- [ ] 再帰ツリーの CRUD 操作ヘルパー関数
- [ ] 親子テキスト同期ロジック
- [ ] Tauri fs API によるファイル保存/読み込み
- [ ] tauri-plugin-store による保存先パスの永続化
- [ ] 自動保存（セル編集 commit 時、debounce 500ms）
- [ ] 起動時の保存先チェック＆ファイル読み込みフロー
- [ ] 💾 保存ボタン（ファイルダイアログで保存先設定/変更）
- [ ] `_images/` フォルダ管理（作成、画像コピー）
- [ ] 画像ガベージコレクション（保存時に未参照画像を削除）
- [ ] JSONインポート機能

### Phase 4: キーボード操作

- [ ] Alt + 数字/テンキー → セルフォーカス
- [ ] Alt + Ctrl + 数字/テンキー → ドリルダウン
- [ ] Alt + U / Alt + ← → ドリルアップ
- [ ] Alt + → → 直前の子階層へ戻る（履歴ナビゲーション）
- [ ] Alt + Shift + 数字 → セル入れ替え（D&Dのキーボード代替）
- [ ] Alt + V → ビュー切り替え（俯瞰⇔ユニット）
- [ ] Alt + E → モーダルエディタ起動
- [ ] Alt + I → 画像追加 / Alt + Shift + I → 画像削除
- [ ] Ctrl + Shift + S → 保存（ファイルダイアログ）
- [ ] Ctrl + E → エクスポート（ファイルダイアログ）
- [ ] Ctrl + Z / Ctrl + Shift + Z → Undo / Redo
- [ ] Enter → 編集確定 / Esc → 編集キャンセル
- [ ] Ctrl + Enter → モーダルエディタ保存 / Esc → モーダルキャンセル
- [ ] 編集中のショートカット伝播処理

### Phase 5: エクスポート

- [ ] 📤 エクスポートボタン（ファイルダイアログで別ファイルに書き出し）
- [ ] JSON エクスポート（実装済み、移植のみ。単一ファイル）
- [ ] Markdown エクスポート（単一ファイル）
- [ ] OPML エクスポート（単一ファイル。MD変換ロジックを流用）

### Phase 6: AIアシスト

- [ ] 設定画面（プロバイダー選択、APIキー入力・暗号化保存、モデル選択、テスト接続）
- [ ] Alt + G によるキーワード生成（実行条件チェック → API呼び出し → セル配置）
- [ ] ローディングUI（オーバーレイ + スピナー）
- [ ] エラーハンドリング（トースト通知）

### Phase 7: 仕上げ

- [ ] アプリアイコン（「曼」ロゴ）・ウィンドウタイトル（「Maṇḍalāya — 曼荼羅盤」）設定
- [ ] ウィンドウの最小サイズ設定
- [ ] エラーハンドリング
- [ ] パフォーマンス最適化（React.memo等）
- [ ] テスト
- [ ] クロスプラットフォームビルド（macOS / Windows / Linux）

---

## 9. 将来の拡張案（バックログ）

以下は本フェーズでは対象外だが、将来的に検討可能な機能:

| 機能 | 概要 |
|------|------|
| draw.io エクスポート | mxGraphModel XML形式。俯瞰表示ごとに分割出力 |
| PNG エクスポート | html2canvas による俯瞰表示の画像化 |
| テンプレート | 目標設定、事業計画、学習計画等のプリセット |
| Bluesky連携 | 完成チャートを画像としてBlueskyに投稿 |
| BSAF連携 | 構造化データとしてのマンダラチャート活用 |
| Web版 | ブラウザ版（クラウドAPI連携によるデバイス間同期が必要） |
| AIアシスト拡張 | 空欄セルのみ部分的に埋めるモード |

---

## 10. 注意事項

### 商標・知的財産

- 「Mandal-Art」は今泉浩晃氏 / ヒロアートディレクションズ社の商標の可能性がある。アプリ名には使用しない
- アプリ名「Maṇḍalāya（曼荼羅盤）」はサンスクリット語の造語であり、既存商標との重複リスクは低いが、正式リリース前に商標調査を推奨
- オリジナルアプリのUIを模倣せず、独自デザインで再構築する
- 商標の正確な状況については専門家への確認を推奨

### 文字数制限

- セルあたり最大1,024文字
- カウント方式: `Intl.Segmenter` による書記素クラスタ単位（Unicode文字種に関わらず1文字=1カウント）
- セル上では枠内に収まる範囲のみ表示（overflow: hidden）。全文はモーダルエディタ（↗ボタン）で編集

### パフォーマンス考慮

- 再帰構造が深い場合（5階層以上）の俯瞰表示レンダリングに注意
- React.memo / useMemo による不要な再レンダリング抑制
- 実用上は3〜4階層が主な使用範囲と想定
